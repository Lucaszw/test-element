= stylesheet_link_tag "fancybox"
= stylesheet_link_tag "galleryView"

= javascript_include_tag "model_objects/imagesloaded"
= javascript_include_tag "model_objects/wookmark"
= javascript_include_tag "model_objects/scrollTo"
= javascript_include_tag "model_objects/model_objects"

      
- # Keep track of how many models have been loaded : 
#main_content
  #gallery_home_container.gallery_container
    #main{role: "main"}
      %ul#tiles
               
  :javascript
    var $tiles = $('#tiles'),
        $handler = $('li', $tiles),
        $main = $('#main'),
        $window = $(window),
        $document = $(document),
        options = {
          autoResize: true, // This will auto-update the layout when the browser window is resized.
          container: $main, // Optional, used for some extra CSS styling
          offset: 20, // Optional, the distance between grid items
          itemWidth: 200 // Optional, the width of a grid item
        };
            

    window.tile_index = 8;
    window.tile_request = "#{model_objects_tile_url}";
    window.canvas_request = "#{model_objects_canvas_url}";
        
    function requestCanvas(modelid) {
      return $.ajax({
        type: "POST",
        url: window.canvas_request,
        data: "modelid=" + modelid,
        dataType: "text",
        success: function(data) {
          return $("#ajaxView").html(data);
        },
        error: function(data) {}
      });
    }
    function requestTile(i) {
      $.ajax({
        type: "POST",
        url: "" + window.tile_request,
        data: { k: i, filter: "act as filter ...." },
        dataType: "text",
        success: function(data) {
            $("#tiles").append(data);         
          },
        error: function(){
          var $items = $('li', $tiles),
          $firstTen = $items.slice(0, 10);
          $tiles.append($firstTen.clone());
        }
        });    
    }
    
    
    
    var i;
    i = 0;
    while (i <= window.tile_index) {
      requestTile(i);
      i++;
    }

  
    (function ($){
    
        
        var oldwidth = $( window ).width();
        var newwidth = oldwidth - 180;
        $(".gallery_container").css("width", newwidth+"px");
        $( window ).resize(function() {
          var oldwidth = $( window ).width();
          var newwidth = oldwidth - 180;
          $(".gallery_container").css("width", newwidth+"px");
        });
        

        $.easing.elasout = function (x, t, b, c, d) {
          // Linear Easing effect :
            return c*t/d + b;
          };
     
        $( "#scrollbutton" ).click(function() {
          $window.scrollTo( "#main_content",300, {easing:'elasout'}  );
        });

        /**
         * Reinitializes the wookmark handler after all images have loaded
         */
        function applyLayout() {
          $tiles.imagesLoaded(function() {
            // Destroy the old handler
            if ($handler.wookmarkInstance) {
              $handler.wookmarkInstance.clear();
            }
            // Create a new layout handler.
            $handler = $('li', $tiles);
            $handler.wookmark(options);
          });
        }

        /**
         * When scrolled all the way to the bottom, add more tiles
         */
        var doUpdate = true ;
        
        function onScroll() {
          // Get the page position :
            var scrolltop = $(document).scrollTop();
            if (scrolltop > window.mintop){
              $('#navigation').css("display", "block");
               $('#cssmenu').css("display", "block");
            }else {
              $('#navigation').css("display", "none");
              $('#cssmenu').css("display", "none");
            }
          
          // Check if we're within 100 pixels of the bottom edge of the broser window.
          var winHeight = window.innerHeight ? window.innerHeight : $window.height(), // iphone fix
              closeToBottom = ($window.scrollTop() + winHeight > $document.height() - 100);
          applyLayout();
          if (closeToBottom && doUpdate) {
            doUpdate = false;
            
            // Get the first then items from the grid, clone them, and add them to the bottom of the grid
  
            for (i = window.tile_index; i < window.tile_index+3; i++) { 
               requestTile(i);
            }
            

            window.tile_index += 3;
                      
            setTimeout(function (){doUpdate = true;}, 1500);
            applyLayout();
          }
                        

        };

        // Call the layout function for the first time
        applyLayout();
        // Capture scroll event.
        $window.bind('scroll.wookmark', onScroll);
        
        
      })(jQuery);

#ajaxView


